<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />

  <!-- PWA & App Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="SUFU 2048" />
  <meta name="theme-color" content="#000000" />
  
  <!-- Manifest: 圖示設定為黑底白字 2048 -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIlNVRlUgMjA0OCIsCiAgInNob3J0X25hbWUiOiAiMjA0OCIsCiAgInN0YXJ0X3VybCI6ICIuIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMDAwMDAwIiwKICAidGhlbWVfY29sb3IiOiAiIzAwMDAwMCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vcGxhY2Vob2xkLmNvLzUxMng1MTIvMDAwMDAwL0ZGRkZGRi9wbmc/dGV4dD0yMDQ4IiwKICAgICAgInNpemVzIjogIjUxMng1MTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9wbmciCiAgICB9CiAgXQp9">

  <title>SUFU 2048 Pro+</title>

  <style>
    :root {
      --bg-color: #bbada0;
      --cell-bg: #cdc1b4;
      --text-dark: #776e65;
      --text-light: #f9f6f2;
      --grid-size: min(92vw, 380px);
      --gap: 10px;
      --tile-size: 75px; 
    }

    * { box-sizing: border-box; -webkit-touch-callout: none; user-select: none; -webkit-tap-highlight-color: transparent; }

    body, html {
      margin: 0; padding: 0; width: 100%; height: 100%;
      background-color: #faf8ef;
      font-family: "Clear Sans", Arial, sans-serif;
      display: flex; align-items: center; justify-content: center;
      overflow: hidden; touch-action: none;
    }

    /* 開場 Splash (SUFU 粒子) */
    #splash-screen {
      position: fixed; inset: 0;
      background: radial-gradient(circle at center, #111, #000);
      z-index: 9999;
      transition: opacity 1s ease;
    }
    #particle-canvas { width: 100%; height: 100%; display: block; }

    /* 遊戲 UI */
    #game-ui {
      opacity: 0;
      transition: opacity 1s ease;
      display: flex; flex-direction: column; align-items: center;
    }

    .header {
      width: var(--grid-size);
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px;
    }

    h1 { font-size: 40px; margin: 0; color: var(--text-dark); letter-spacing: -2px; }

    .scores-wrapper { display: flex; gap: 6px; }
    .score-container {
      background: var(--bg-color);
      padding: 6px 12px; border-radius: 6px;
      color: #fff; text-align: center; min-width: 65px;
    }
    .score-label { font-size: 10px; font-weight: bold; opacity: 0.8; }
    .score-value { font-size: 20px; font-weight: bold; }

    #game-container {
      position: relative;
      width: var(--grid-size);
      height: var(--grid-size);
      background: var(--bg-color);
      border-radius: 8px;
      padding: var(--gap);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    }

    .grid-bg {
      display: grid; grid-template-columns: repeat(4, 1fr); grid-template-rows: repeat(4, 1fr);
      gap: var(--gap); width: 100%; height: 100%;
    }
    .grid-cell { background: var(--cell-bg); border-radius: 4px; }

    #tile-container { position: absolute; inset: var(--gap); z-index: 10; pointer-events: none; }

    .tile {
      position: absolute;
      width: var(--tile-size); height: var(--tile-size);
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; border-radius: 4px;
      font-size: clamp(20px, 6vw, 32px);
      transition: transform 120ms cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 11;
    }

    .n-2 { background: #eee4da; color: #776e65; }
    .n-4 { background: #ede0c8; color: #776e65; }
    .n-8 { background: #f2b179; color: #fff; }
    .n-16 { background: #f59563; color: #fff; }
    .n-32 { background: #f67c5f; color: #fff; }
    .n-64 { background: #f65e3b; color: #fff; }
    .n-128 { background: #edcf72; color: #fff; box-shadow: 0 0 10px rgba(237, 207, 114, 0.5); }
    .n-256 { background: #edcc61; color: #fff; }
    .n-512 { background: #edc850; color: #fff; }
    .n-1024 { background: #edc53f; color: #fff; font-size: 22px; }
    .n-2048 { 
      background: #edc22e; color: #fff; font-size: 22px;
      animation: glow 1.5s infinite alternate;
    }

    @keyframes glow {
      from { box-shadow: 0 0 10px #edc22e; }
      to { box-shadow: 0 0 30px #fff, 0 0 40px #edc22e; }
    }

    .tile-new { animation: appear 160ms ease-out; }
    .tile-merged { animation: pop 160ms ease-out; z-index: 12; }

    @keyframes appear { from { transform: scale(0); } to { transform: scale(1); } }
    @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.18); } 100% { transform: scale(1); } }

    .game-over {
      position: absolute; inset: 0;
      background: rgba(238, 228, 218, 0.9);
      display: none; flex-direction: column; align-items: center; justify-content: center;
      z-index: 100; border-radius: 8px;
    }

    button {
      background: #8f7a66; color: #fff; border: none;
      padding: 12px 24px; border-radius: 4px; font-size: 16px; font-weight: bold; cursor: pointer;
    }
  </style>
</head>
<body>

  <div id="splash-screen"><canvas id="particle-canvas"></canvas></div>

  <div id="game-ui">
    <div class="header">
      <h1>2048</h1>
      <div class="scores-wrapper">
        <div class="score-container">
          <div class="score-label">SCORE</div>
          <div id="score" class="score-value">0</div>
        </div>
        <div class="score-container">
          <div class="score-label">BEST</div>
          <div id="best-score" class="score-value">0</div>
        </div>
      </div>
    </div>

    <div id="game-container">
      <div class="grid-bg">
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
        <div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div><div class="grid-cell"></div>
      </div>
      <div id="tile-container"></div>
      <div id="game-over" class="game-over">
        <h2 style="color:#776e65;font-size:40px;margin:0">Game Over</h2>
        <button onclick="resetGame()">Try Again</button>
      </div>
    </div>
    <p style="margin-top:16px;font-size:13px;color:#776e65;opacity:.6">滑動後或用方向鍵</p>
  </div>

  <script>
    /* 1. 音效引擎 */
    let audioCtx = null;
    function initAudio() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    function playMergeSound() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine'; osc.connect(gain); gain.connect(audioCtx.destination);
      const now = audioCtx.currentTime;
      osc.frequency.setValueAtTime(440, now);
      osc.frequency.exponentialRampToValueAtTime(880, now + 0.05);
      gain.gain.setValueAtTime(0.1, now);
      gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
      osc.start(); osc.stop(now + 0.1);
    }

    /* 2. Splash 粒子 */
    const canvas = document.getElementById('particle-canvas');
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    let particles = [], exploding = false, splashActive = true;

    function initSplash() {
      const w = innerWidth, h = innerHeight;
      canvas.width = w * dpr; canvas.height = h * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      const off = document.createElement('canvas');
      off.width = w; off.height = h;
      const o = off.getContext('2d');
      const fontSize = Math.min(w / 2.6, 260);
      o.fillStyle = '#fff'; o.font = `900 ${fontSize}px Arial Black`;
      o.textAlign = 'center'; o.textBaseline = 'middle';
      o.fillText('SUFU', w/2, h/2);
      const data = o.getImageData(0,0,w,h).data;
      for(let y=0; y<h; y+=3) {
        for(let x=0; x<w; x+=3) {
          if(data[(y*w+x)*4]>150) {
            particles.push({x, y, ox:x, oy:y, vx:(Math.random()-.5)*10, vy:(Math.random()-.5)*10, life:1, size:Math.random()*1.8+0.6});
          }
        }
      }
      setTimeout(()=>exploding=true, 1800);
      setTimeout(endSplash, 2600);
    }
    function endSplash() {
      document.getElementById('splash-screen').style.opacity = 0;
      document.getElementById('game-ui').style.opacity = 1;
      initAudio();
      setTimeout(() => { splashActive = false; document.getElementById('splash-screen').remove(); }, 1000);
    }
    function animateSplash() {
      if(!splashActive) return;
      ctx.clearRect(0,0,innerWidth,innerHeight);
      particles.forEach(p => {
        if(exploding){ p.x+=p.vx; p.y+=p.vy; p.vx*=.98; p.vy*=.98; p.life-=.015; }
        else { p.x=p.ox+Math.sin(Date.now()/400+p.ox)*1.2; p.y=p.oy+Math.cos(Date.now()/400+p.oy)*1.2; }
        if(p.life>0){ ctx.globalAlpha=p.life; ctx.fillStyle='#fff'; ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill(); }
      });
      requestAnimationFrame(animateSplash);
    }

    /* 3. 2048 引擎 */
    const tileContainer = document.getElementById('tile-container');
    const scoreEl = document.getElementById('score');
    const bestEl = document.getElementById('best-score');
    const overEl = document.getElementById('game-over');
    let board, score, bestScore, over, tileSize, gapSize = 10;

    function resizeGame() {
      const container = document.getElementById('game-container');
      tileSize = (container.clientWidth - gapSize * 5) / 4;
      document.documentElement.style.setProperty('--tile-size', tileSize + 'px');
      if (board) board.flat().filter(Boolean).forEach(t => placeTile(t.r, t.c, t.el));
    }

    function initGame() {
      board = Array.from({ length: 4 }, () => Array(4).fill(null));
      score = 0; over = false;
      bestScore = parseInt(localStorage.getItem('2048-best')) || 0;
      tileContainer.innerHTML = '';
      scoreEl.textContent = '0';
      bestEl.textContent = bestScore;
      overEl.style.display = 'none';
      resizeGame();
      addTile(); addTile();
    }

    function updateScore(val) {
      const prevBest = bestScore;
      score += val;
      scoreEl.textContent = score;
      if (score > bestScore) {
        // 關鍵更新：每當破紀錄時觸發短震動 (20ms)
        if (score > prevBest && navigator.vibrate) navigator.vibrate(20);
        bestScore = score;
        bestEl.textContent = bestScore;
        localStorage.setItem('2048-best', bestScore);
      }
    }

    function addTile() {
      const empty = [];
      for(let r=0; r<4; r++) for(let c=0; c<4; c++) if(!board[r][c]) empty.push({r,c});
      if(!empty.length) return;
      const {r,c} = empty[Math.floor(Math.random()*empty.length)];
      const val = Math.random()<0.9?2:4;
      const el = document.createElement('div');
      el.className = `tile n-${val} tile-new`;
      el.textContent = val;
      tileContainer.appendChild(el);
      board[r][c] = {val, el, r, c};
      placeTile(r,c,el);
    }

    function placeTile(r, c, el) {
      const x = c * (tileSize + gapSize);
      const y = r * (tileSize + gapSize);
      el.style.transform = `translate(${x}px, ${y}px)`;
    }

    function move(dir) {
      if(over || splashActive) return;
      let moved = false;
      const isV = dir==='up'||dir==='down', isR = dir==='right'||dir==='down';
      for(let i=0; i<4; i++){
        let line = [];
        for(let j=0; j<4; j++) line.push(isV?board[j][i]:board[i][j]);
        if(isR) line.reverse();
        let filtered = line.filter(Boolean);
        for(let k=0; k<filtered.length-1; k++){
          if(filtered[k].val === filtered[k+1].val){
            filtered[k].val *= 2;
            updateScore(filtered[k].val);
            playMergeSound();
            if(filtered[k].val === 2048 && navigator.vibrate) navigator.vibrate(50);
            const target = filtered[k], source = filtered[k+1];
            source.el.style.opacity = 0;
            source.el.style.transform = target.el.style.transform;
            setTimeout(()=>source.el.remove(), 100);
            target.el.textContent = target.val;
            target.el.className = `tile n-${target.val} tile-merged`;
            filtered.splice(k+1, 1); moved = true;
          }
        }
        while(filtered.length<4) filtered.push(null);
        if(isR) filtered.reverse();
        for(let j=0; j<4; j++){
          const r = isV?j:i, c = isV?i:j;
          if(board[r][c] !== filtered[j]) moved = true;
          board[r][c] = filtered[j];
          if(board[r][c]) { board[r][c].r = r; board[r][c].c = c; placeTile(r, c, board[r][c].el); }
        }
      }
      if(moved){ setTimeout(addTile, 120); setTimeout(checkOver, 200); }
    }

    function checkOver() {
      for(let r=0; r<4; r++) for(let c=0; c<4; c++){
        if(!board[r][c]) return;
        if(r<3 && board[r][c].val===board[r+1][c]?.val) return;
        if(c<3 && board[r][c].val===board[r][c+1]?.val) return;
      }
      over = true; overEl.style.display = 'flex';
    }

    function resetGame() { initGame(); }
    window.addEventListener('keydown', e => {
      const m = {ArrowUp:'up',ArrowDown:'down',ArrowLeft:'left',ArrowRight:'right'};
      if(m[e.key]){ e.preventDefault(); move(m[e.key]); }
    });
    let sx, sy;
    addEventListener('touchstart', e => { sx=e.touches[0].clientX; sy=e.touches[0].clientY; }, {passive:true});
    addEventListener('touchend', e => {
      const dx=e.changedTouches[0].clientX-sx, dy=e.changedTouches[0].clientY-sy;
      if(Math.max(Math.abs(dx),Math.abs(dy))>30) move(Math.abs(dx)>Math.abs(dy)?(dx>0?'right':'left'):(dy>0?'down':'up'));
    });
    window.addEventListener('resize', resizeGame);
    initSplash(); animateSplash(); initGame();
  </script>
</body>
</html>
